services:
  # Test database - ephemeral, only for tests
  prospectflow-test-db:
    image: postgres:16-alpine
    container_name: prospectflow-test-db
    environment:
      POSTGRES_DB: prospectflow_test
      POSTGRES_USER: prospectflow
      POSTGRES_PASSWORD: testpassword123
    networks:
      - prospectflow-test-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U prospectflow']
      interval: 5s
      timeout: 5s
      retries: 5

  # Test Redis - ephemeral, only for tests
  prospectflow-test-redis:
    image: redis:7-alpine
    container_name: prospectflow-test-redis
    networks:
      - prospectflow-test-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 5

  # Test RabbitMQ - ephemeral, only for tests
  prospectflow-test-rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: prospectflow-test-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: prospectflow
      RABBITMQ_DEFAULT_PASS: testpassword123
    networks:
      - prospectflow-test-network
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', 'check_running']
      interval: 10s
      timeout: 10s
      retries: 5

  # Test runner - runs all tests including integration
  prospectflow-test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: prospectflow-test-runner
    environment:
      - NODE_ENV=test
      - POSTGRES_HOST=prospectflow-test-db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=prospectflow
      - POSTGRES_PASSWORD=testpassword123
      - POSTGRES_DB=prospectflow_test
      - REDIS_HOST=prospectflow-test-redis
      - REDIS_PORT=6379
      - RABBITMQ_HOST=prospectflow-test-rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=prospectflow
      - RABBITMQ_PASS=testpassword123
      # Cognito test values (mocked in tests)
      - COGNITO_USER_POOL_ID=eu-west-1_testpool
      - COGNITO_CLIENT_ID=test-client-id
      - COGNITO_ISSUER=https://cognito-idp.eu-west-1.amazonaws.com/eu-west-1_testpool
      - AWS_REGION=eu-west-1
      - LOG_LEVEL=error
      - PORT=3000
      - CORS_ORIGIN=http://localhost:3000
    depends_on:
      prospectflow-test-db:
        condition: service_healthy
      prospectflow-test-redis:
        condition: service_healthy
      prospectflow-test-rabbitmq:
        condition: service_healthy
    networks:
      - prospectflow-test-network

networks:
  prospectflow-test-network:
    driver: bridge
